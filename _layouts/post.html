---
layout: default
---

<!-- Page Header -->
{% if page.background %}
<header class="masthead" style="background-image: url('{{ page.background | prepend: site.baseurl | replace: '//', '/' }}')">
  {% else %}
  <header class="masthead">
    {% endif %}
    <div class="overlay"></div>
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-md-10 mx-auto">
          <div class="post-heading">
            <h1>{{ page.title }}</h1>
            {% if page.subtitle %}
            <h2 class="subheading">{{ page.subtitle }}</h2>
            {% endif %}
            <span class="meta">Автор 
              <a href="#">{% if page.author %}{{ page.author }}{% else %}{{ site.author }}{% endif %}</a>
              {{ page.date | date: '%d.%m.%Y' }} &middot; {% include read_time.html
              content=page.content %}
                  {% if page.tags %}
                      · Теги: {{ page.tags | join: ", " }}
                  {% endif %}
            </span>
          </div>
        </div>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-md-10 mx-auto">

        {{ content }}
        {% include telegram.html %}
        <hr>

        <div class="clearfix">

          {% if page.previous.url %}
          <a class="btn btn-primary float-left" href="{{ page.previous.url | prepend: site.baseurl | replace: '//', '/' }}" data-toggle="tooltip" data-placement="top" title="{{ page.previous.title }}">Предыдущая<span class="d-none d-md-inline">
              статья</span></a>
          {% endif %}
          {% if page.next.url %}
          <a class="btn btn-primary float-right" href="{{ page.next.url | prepend: site.baseurl | replace: '//', '/' }}" data-toggle="tooltip" data-placement="top" title="{{ page.next.title }}">Следущая<span class="d-none d-md-inline">
              статья</span></a>
          {% endif %}

        </div>

        {% assign maxRelated = 4 %}
        {% assign minCommonTags = 1 %}
        {% assign relatedCount = 0 %}

        <!-- 1. СОБИРАЕМ И ОЦЕНИВАЕМ ВСЕ ПОДХОДЯЩИЕ СТАТЬИ -->
        {% capture rawRelatedPosts %}
          {% for otherPost in site.posts %}
            {% if otherPost.url != page.url %} <!-- Исключаем текущую статью -->
              {% assign commonTags = 0 %}
              {% for tag in otherPost.tags %}
                {% if page.tags contains tag %}
                  {% assign commonTags = commonTags | plus: 1 %}
                {% endif %}
              {% endfor %}

              {% if commonTags >= minCommonTags %}
                {% assign relevance = commonTags | times: 2.0 | divided_by: page.tags.size | plus: otherPost.tags.size | times: 100 %}
                <!-- Формируем строку для сортировки: РЕЙТИНГ|ЗАГОЛОВОК|URL -->
                |{{ relevance }}#{{ otherPost.title }}#{{ otherPost.url }}
                {% assign relatedCount = relatedCount | plus: 1 %}
              {% endif %}
            {% endif %}
          {% endfor %}
        {% endcapture %}

        <!-- 2. СОРТИРУЕМ ПО РЕЙТИНГУ (по убыванию) И БЕРЁМ ТОП-N -->
        {% assign sortedPosts = rawRelatedPosts | split: '|' | sort | reverse %}

        <!-- 3. ВЫВОДИМ РЕЗУЛЬТАТ -->
        {% if relatedCount > 0 %}
        <hr>
        <h2>Вам также может быть интересно:</h2>
        <ul>
          {% assign displayCount = 0 %}
          {% for postData in sortedPosts %}
            {% if postData != "" and displayCount < maxRelated %}
              {% assign parts = postData | split: '#' %}
              <!-- parts[0] = рейтинг, parts[1] = заголовок, parts[2] = URL -->
              <li>
                <a href="{{ parts[2] | relative_url }}">{{ parts[1] }}</a>
                <!-- Для отладки можно раскомментировать: <small>(релевантность: {{ parts[0] | round: 2 }})</small> -->
              </li>
              {% assign displayCount = displayCount | plus: 1 %}
            {% endif %}
          {% endfor %}
        </ul>
        {% endif %}

      </div>
    </div>
  </div>
